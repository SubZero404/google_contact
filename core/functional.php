<?phptry {    // this function will install database tables when tables is not exists in database    function installDataBase() {        createContactsTable();    }    function runSqlQuery($sql,$method = 'post') {        global $mysqli;        if ($method == 'post') {            if (!$mysqli->query($sql)) {                throw new Exception($mysqli->error);            }        } elseif ($method == 'get-all') {            $data_array = [];            if (!$sql_data = $mysqli->query($sql)) {                throw new Exception($mysqli->error);            } else {                while ($row = mysqli_fetch_assoc($sql_data)) {                    array_push($data_array,$row);                }            }            return $data_array;        } elseif ($method == 'get') {            if (!$sql_data = $mysqli->query($sql)) {                throw new Exception($mysqli->error);            } else {                return mysqli_fetch_assoc($sql_data);            }        } else {            return throw new Exception("Run Query, Wrong Method");        }    }// will create contacts table when it not exists in database    function createContactsTable() {        $sql = "        CREATE TABLE IF NOT EXISTS contact (            id INT(11) NOT NULL AUTO_INCREMENT PRIMARY KEY ,            first_name VARCHAR(255) ,            last_name VARCHAR(255) ,            company LONGTEXT ,            job_title LONGTEXT ,            email VARCHAR(255) ,            phone VARCHAR(25) ,            birthday LONGTEXT ,            notes LONGTEXT ,            profile_img VARCHAR(255) ,            star ENUM('0','1') DEFAULT '0' ,            create_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP()         )        ";        runSqlQuery($sql);    }    // to add new contact --------------------    function addContact($first_name,$last_name,$company,$job_title,$email,$phone,$birthday,$notes,$img,$local_img) {        global $sub_url;        if ($img === '' and $local_img === '') {            $sql = "INSERT INTO contact(first_name, last_name, company, job_title, email, phone, birthday, notes)                     VALUES ('$first_name','$last_name','$company','$job_title','$email','$phone','$birthday','$notes')";            runSqlQuery($sql);            linkTo($sub_url['main_url']);        } elseif ($local_img !== "") {            $img_dir = './assets/img/contact_img/';            $local_img_arr = scandir($img_dir);            if (in_array($local_img,$local_img_arr)) {                $sql = "INSERT INTO contact(first_name, last_name, company, job_title, email, phone, birthday, notes , profile_img)                     VALUES ('$first_name','$last_name','$company','$job_title','$email','$phone','$birthday','$notes','$local_img')";                runSqlQuery($sql);                linkTo($sub_url['main_url']);            } else {                setError('image',"This image is not exit in this program");            }        } elseif ($img !== "") {            $contact_user_img = "./assets/img/contact_user_img/";            if ($img = base64ToImage($img,$contact_user_img)) {                $sql = "INSERT INTO contact(first_name, last_name, company, job_title, email, phone, birthday, notes ,profile_img)                     VALUES ('$first_name','$last_name','$company','$job_title','$email','$phone','$birthday','$notes','$img')";                runSqlQuery($sql);                linkTo($sub_url['main_url']);            } else {                setError('image',"Please enter png/jpeg image only");            }        } else {            throw new Exception("Add Contact Error");        }    }    // to edit contact ----------------------------    function editContact($id,$first_name,$last_name,$company,$job_title,$email,$phone,$birthday,$notes,$img,$local_img) {        if (!$img and !$local_img) {            $sql = "UPDATE contact SET first_name='$first_name', last_name='$last_name', company='$company',                    job_title='$job_title',email='$email',phone='$phone',birthday='$birthday',                    notes='$notes' WHERE id = '$id'";            runSqlQuery($sql);        } else {            $img_dir = './assets/img/contact_img/';            $contact_user_img = "./assets/img/contact_user_img/";            $local_img_arr = scandir($img_dir);            $contact_user_img_arr = scandir($contact_user_img);            $origin_img = runSqlQuery("SELECT profile_img FROM contact WHERE id = $id",'get')['profile_img'];            $need_to_del_img = 0;            if (in_array($origin_img,$contact_user_img_arr)) $need_to_del_img = 1;            if ($local_img) {                if (in_array($local_img,$local_img_arr)) {                    $sql = "UPDATE contact SET first_name='$first_name', last_name='$last_name', company='$company',                    job_title='$job_title',email='$email',phone='$phone',birthday='$birthday',                    notes='$notes',profile_img='$local_img' WHERE id = '$id'";                    runSqlQuery($sql);                    if ($need_to_del_img) deleteProfileImage($id,$origin_img);                } else {                    setError('image',"This image is not exit in this program");                }            } elseif ($img) {                if ($img = base64ToImage($img,$contact_user_img)) {                    $sql = "UPDATE contact SET first_name='$first_name', last_name='$last_name', company='$company',                    job_title='$job_title',email='$email',phone='$phone',birthday='$birthday',                    notes='$notes',profile_img='$img' WHERE id = '$id'";                    runSqlQuery($sql);                    if ($need_to_del_img) deleteProfileImage($id,$origin_img);                } else {                    setError('image',"Please enter png/jpeg image only");                }            }        }    }    // to get all contact -----------------------    function getContacts($type = ""): array|bool|null    {        if ($type === "star") {            $sql = "SELECT * FROM contact WHERE star = '1'";        } else {            $sql = "SELECT * FROM contact WHERE star = '0'";        }        return runSqlQuery($sql,'get-all');    }    // to get each contact ----------------------    function getEachContact($id): array|bool|null    {        $id = textFilter($id);        $sql = "SELECT * FROM contact WHERE id = '$id'";        return runSqlQuery($sql,'get');    }    // to delete each contact --------------    function deleteContact($id) {        $id = textFilter($id);        $sql = "DELETE FROM contact WHERE id = '$id'";        runSqlQuery($sql);    }    // to get count of contact    function getContactCount($type = "all") {        if ($type === "all") {            $sql = "SELECT COUNT(id) AS 'total' FROM contact";            return runSqlQuery($sql,'get')['total'];        } elseif ($type === "not-star") {            $sql = "SELECT COUNT(id) AS 'total' FROM contact WHERE star = '0' ";            return runSqlQuery($sql,'get')['total'];        } elseif ($type === "stared") {            $sql = "SELECT COUNT(id) AS 'total' FROM contact WHERE star = '1' ";            return runSqlQuery($sql,'get')['total'];        } else {            throw new Exception("get contact error");        }    }    // to delete profile image that user input    function deleteProfileImage($id,$origin_img = null) {        if ($origin_img) {            $profile_image = $origin_img;        } else {            $image = runSqlQuery("SELECT profile_img FROM contact WHERE id = $id",'get');            $profile_image = $image['profile_img'];        }        $contact_user_img_path = "./assets/img/contact_user_img/";        $contact_user_img_arr = scandir($contact_user_img_path);        if (in_array($profile_image,$contact_user_img_arr)) unlink($contact_user_img_path.$profile_image);    }    // to toggle star contact    function toggleStar($value) {        $value = explode('/',$value);        $contact_id = $value[0];        $star = $value[1];        $sql = "SELECT star FROM contact WHERE id = $contact_id";        $check_star = runSqlQuery($sql,'get')['star'];        if ($star === $check_star) {            if ($star === '0') {                $sql = "UPDATE contact SET star = '1' WHERE id = $contact_id";                runSqlQuery($sql);            } elseif ($star === '1') {                $sql = "UPDATE contact SET star = '0' WHERE id = $contact_id";                runSqlQuery($sql);            }        }    }    // convert base64 to String    function base64ToImage($base_64_string,$file_path): string    {        $data = explode(',',$base_64_string);        if (count($data) > 1) {            $file_extension = explode(';',explode(':',$data[0])[1])[0];            $file_type = explode('/',$file_extension)[1];            if (in_array($file_extension,['image/jpeg','image/png'])) {                $file_name = "contact_img_".uniqid().".".$file_type;                $file = fopen($file_path.$file_name,'wb');                fwrite($file,base64_decode($data[1]));                fclose($file);                return $file_name;            } else {                setError('image',"unsupported file type");                return false;            }        }else {            setError('image',"not a base64 image");            return false;        }    }    function getImageUrl($img): string    {        global $sub_url;        $local_img_arr = scandir('./assets/img/contact_img/');        $user_img_arr = scandir('./assets/img/contact_user_img/');        if (in_array($img,$local_img_arr)) {            $img_url = $sub_url['contact_img_url'].$img;        } elseif(in_array($img,$user_img_arr)) {            $img_url = $sub_url['contact_user_img_url'].$img;        } else {            $img_url = $sub_url['profile_img_url'].'profile_thumbnail.jpg';        }        return $img_url;    }    function textFilter($str): string {        $str = trim($str);        $str = htmlentities($str,ENT_QUOTES);        return stripcslashes($str);    }    function linkTo($path) {        echo "<script> location.href = '$path' </script>";    }    //Form Validation    function validation(): int    {        $error = 0;        if (isset($_POST['first-name']) or isset($_POST['last-name'])) {            $name = $_POST['first-name'].$_POST['last-name'];            if (empty($name)) {                setError('name','contact name should not be empty!');                $error = 1;            } else if (!preg_match("/^[a-zA-Z0-9-' ]*$/",$name)) {                setError('name','contact name should be a-z , A-Z , 0-9');                $error = 1;            }        }        if (isset($_POST['email'])) {            $email = $_POST['email'];            if (!empty($email) and !filter_var($email,FILTER_VALIDATE_EMAIL)) {                setError('email','Email is not valid');                $error = 1;            }        }        if (isset($_POST['phone'])) {            $phone = $_POST['phone'];            if (!empty($phone) and !(preg_match("/^[0-9+ ]*$/",$phone))) {                setError('phone','Phone Number is not valid');                $error = 1;            }        }        return $error;    }    function setError($name,$message) {        $_SESSION['error'][$name] = $message;    }    function getError($name) {        if (isset($_SESSION['error'][$name])) {            return "<small class='text-danger mb-3' style='transform: translateY(-15px)'>{$_SESSION['error'][$name]}</small>";        } else {            return "";        }    }    function clearError() {        $_SESSION['error'] = [];    }    installDataBase();} catch (Exception $e) {    echo "<h1 style='text-align: center; width: 100%; color: red'>Sorry system is under maintain.</h1> <pre>";    print_r($e);    exit();}